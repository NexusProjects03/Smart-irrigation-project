================================================================================
                    ML MODEL & AI INTEGRATION â€” DETAILED ANALYSIS
                          Smart Agriculture NPK System
================================================================================

Generated: 23 February 2026
Project: Smart Agriculture NPK Web Dashboard
Location: backend/ml_model.pkl

================================================================================
1. ML MODEL OVERVIEW
================================================================================

Model Type       : Random Forest Classifier (Ensemble Learning)
Library          : scikit-learn (sklearn.ensemble.RandomForestClassifier)
Training Script  : backend/train_model.py
Saved Model File : backend/ml_model.pkl (serialized with Python pickle)

Hyperparameters:
  - n_estimators : 200 (number of decision trees in the forest)
  - max_depth    : None (trees grow until all leaves are pure or min_samples)
  - random_state : 42 (ensures reproducible results)
  - criterion    : gini (default â€” Gini Impurity for split quality)
  - min_samples_split : 2 (default)
  - min_samples_leaf  : 1 (default)
  - bootstrap         : True (default â€” samples drawn with replacement)

Train/Test Split:
  - Test Size    : 20% (0.2)
  - Random State : 42
  - Stratified   : No (default)

Expected Accuracy: ~97-99%
  (Random Forest with 200 trees on a clean, balanced, 2000-sample agricultural
   dataset typically achieves very high accuracy due to well-separated feature
   distributions across crop types.)

================================================================================
2. DATASET INFORMATION
================================================================================

Dataset File     : backend/Crop_dataset.csv
Total Samples    : 2,000
Total Features   : 6 (input) + 1 (target label)

Features (Input Variables):
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Feature          â”‚ Unit      â”‚ Description                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ N                â”‚ mg/kg     â”‚ Nitrogen content in soil             â”‚
  â”‚ P                â”‚ mg/kg     â”‚ Phosphorus content in soil           â”‚
  â”‚ K                â”‚ mg/kg     â”‚ Potassium content in soil            â”‚
  â”‚ temperature      â”‚ Â°C        â”‚ Ambient/soil temperature             â”‚
  â”‚ soil_moisture    â”‚ %         â”‚ Soil moisture percentage             â”‚
  â”‚ ph               â”‚ pH scale  â”‚ Soil pH level (acidity/alkalinity)   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Target Variable  : crop (categorical â€” name of the recommended crop)

Crop Classes (5 classes, 400 samples each â€” perfectly balanced):
  1. Rice         (400 samples)  â€” Rows 2 to 401
  2. Wheat        (400 samples)  â€” Rows 402 to 801
  3. Maize        (400 samples)  â€” Rows 802 to 1201
  4. Cotton       (400 samples)  â€” Rows 1202 to 1601
  5. Sugarcane    (400 samples)  â€” Rows 1602 to 2001

================================================================================
3. HOW THE RANDOM FOREST ALGORITHM WORKS
================================================================================

Random Forest is an ensemble machine learning method that operates by
constructing multiple decision trees during training and outputting the
class that is the mode (majority vote) of the classes predicted by
individual trees.

Step-by-Step Process:
  1. BOOTSTRAP SAMPLING: For each of the 200 trees, a random subset of the
     2,000 training samples is drawn WITH replacement (bagging).

  2. TREE CONSTRUCTION: Each tree is built by recursively splitting nodes
     using the best feature and threshold. At each node, only a random
     subset of features (sqrt(6) â‰ˆ 2-3 features) is considered for splitting.

  3. SPLIT CRITERION (Gini Impurity):
     Gini(t) = 1 - Î£ [p(i|t)]Â²
     Where p(i|t) is the proportion of class i samples at node t.
     A Gini of 0 means a pure node (all samples belong to one class).

  4. PREDICTION: For a new input, each of the 200 trees independently
     predicts a crop class. The final prediction is determined by
     majority voting across all trees.

  5. PROBABILITY ESTIMATION:
     P(class_k) = (Number of trees voting for class_k) / 200
     This probability is used as the "confidence" percentage in the app.

Key Formulas:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Gini Impurity:   G(t) = 1 - Î£áµ¢ [p(i|t)]Â²                        â”‚
  â”‚ Information Gain: Î”G = G(parent) - Î£ (wâ±¼ Ã— G(childâ±¼))            â”‚
  â”‚ Confidence:       conf = (votes_for_class / total_trees) Ã— 100    â”‚
  â”‚ Accuracy:         acc = correct_predictions / total_predictions    â”‚
  â”‚ Feature Importance: mean decrease in Gini across all tree splits  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

================================================================================
4. PREDICTION PIPELINE IN THE APPLICATION
================================================================================

When a user clicks "Check Suitable Crops", the following pipeline executes:

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Sensor Data â”‚ â”€â”€> â”‚ ML Model     â”‚ â”€â”€> â”‚ Ranked Crops   â”‚
  â”‚ (N,P,K,     â”‚     â”‚ predict_     â”‚     â”‚ (up to 25)     â”‚
  â”‚  temp,moist, â”‚    â”‚ proba()      â”‚     â”‚                â”‚
  â”‚  pH)        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Priority Merge:  â”‚
                    â”‚ 1. Favorites â¤ï¸  â”‚
                    â”‚ 2. User Crops ğŸŒ¿ â”‚
                    â”‚ 3. ML Model ğŸ¤–  â”‚
                    â”‚ 4. AI Fallback ğŸ§ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Prediction Priority System:
  1. FAVORITES: User-favorited crops are evaluated against sensor data
     using a rule-based scoring system (6 checks: N, P, K, temp, moist, pH).
     Each check scores 1.0 (in range), 0.5 (within 20% margin), or 0 (out).
     Final confidence = (score / 6) Ã— 100%.

  2. USER CROPS: Same rule-based scoring as favorites, but lower priority.

  3. ML PREDICTIONS: The RandomForest model predicts probabilities for all
     5 crop classes. All predictions are included regardless of confidence.

  4. AI FALLBACK: If the total is still below 25 crops, the system asks
     the integrated AI model (OpenAI GPT-oss-20b) for additional suggestions
     to fill the remaining slots. Retry logic ensures reliability.

User Crop Confidence Formula:
  score = Î£ check(sensor_value, crop_min, crop_max) for each of 6 params
  confidence = (score / 6) Ã— 100

  Where check() returns:
    1.0  if  min â‰¤ value â‰¤ max
    0.5  if  (min - 20% margin) â‰¤ value â‰¤ (max + 20% margin)
    0.0  otherwise

================================================================================
5. INTEGRATED AI MODEL
================================================================================

AI Provider      : OpenRouter (https://openrouter.ai)
AI Model         : openai/gpt-oss-20b:free (OpenAI GPT-oss 20B parameters)
API Endpoint     : https://openrouter.ai/api/v1/chat/completions
Reasoning Mode   : Enabled (two-step reasoning API flow)

AI is used for two purposes in this application:

  A. CROP DATA SEARCH (AI Add Crop):
     When a user searches for a new crop by name, the AI provides:
     - Ideal N, P, K ranges (mg/kg)
     - Ideal pH range
     - Ideal temperature range (Â°C)
     - Ideal moisture range (%)
     - Detailed analysis and growing advice
     The AI compares these ideal values against live sensor data
     (if available) to provide specific recommendations.

  B. PREDICTION FALLBACK (Fill to 25 Crops):
     When the ML model + user crops total fewer than 25 recommendations,
     the AI suggests additional suitable crops based on current soil
     conditions to fill the list. Includes retry logic (up to 2 attempts).

Two-Step Reasoning Flow:
  Step 1: Send prompt with reasoning enabled â†’ model reasons internally
  Step 2: Pass reasoning_details back â†’ request final formatted JSON output
  This ensures reliable, structured JSON responses free of markdown artifacts.

================================================================================
6. SYSTEM ARCHITECTURE SUMMARY
================================================================================

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                    SMART AGRICULTURE SYSTEM                        â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                                     â”‚
  â”‚  HARDWARE LAYER                                                     â”‚
  â”‚  â”œâ”€â”€ Arduino (NPK sensors, pH, temp, moisture via Serial/USB)      â”‚
  â”‚  â””â”€â”€ Firebase Realtime DB (Cloud Mode alternative)                  â”‚
  â”‚                                                                     â”‚
  â”‚  BACKEND (Flask + Python)                                           â”‚
  â”‚  â”œâ”€â”€ ML Model: RandomForest (200 trees, 5 crops, 6 features)      â”‚
  â”‚  â”œâ”€â”€ AI Integration: OpenAI GPT-oss-20b via OpenRouter             â”‚
  â”‚  â”œâ”€â”€ Email Alerts: Resend API (moisture alerts + AI search logs)   â”‚
  â”‚  â””â”€â”€ REST API: /api/predict, /api/ai-add-crop, /api/crops, etc.   â”‚
  â”‚                                                                     â”‚
  â”‚  FRONTEND (HTML/CSS/JS)                                             â”‚
  â”‚  â”œâ”€â”€ Real-time sensor dashboard (USB + Cloud modes)                â”‚
  â”‚  â”œâ”€â”€ Crop recommendation tiles with confidence scores              â”‚
  â”‚  â”œâ”€â”€ AI-powered crop search with analysis                          â”‚
  â”‚  â”œâ”€â”€ Smart motor control with rain/weather integration             â”‚
  â”‚  â””â”€â”€ Compatibility checker with actionable suggestions             â”‚
  â”‚                                                                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

================================================================================
7. FILES REFERENCE
================================================================================

  backend/train_model.py     â€” Trains the RandomForest model & saves .pkl
  backend/ml_model.pkl       â€” Serialized trained model (pickle format)
  backend/Crop_dataset.csv   â€” Training dataset (2000 samples, 5 crops)
  backend/app.py             â€” Flask server with ML + AI integration
  backend/.env               â€” API keys (OpenRouter, Resend, Firebase)
  backend/crops.json         â€” User-added crop data (persistent storage)
  frontend/index.html        â€” Dashboard UI
  frontend/script.js         â€” Frontend logic (sensor polling, predictions)
  frontend/style.css         â€” UI styling and themes

================================================================================
                              END OF DOCUMENT
================================================================================
